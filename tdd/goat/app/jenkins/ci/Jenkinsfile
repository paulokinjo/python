pipeline {

	agent any
  
	environment {
    WORK_DIR               = 'tdd/goat/app'
		DOCKERHUB_CREDENTIALS  = 'dockerhub-cred-paulo'
    IMAGE_NAME             = "paulokinjo/python-superlists"
    GIT_COMMIT             = sh(returnStdout: true, script: 'git log --format="%H" -n 1')
    IMAGE_TAG              = sh(returnStdout: true, script: "echo ${env.BUILD_NUMBER}${env.GIT_COMMIT}")        
	}

	stages {
		stage('Docker Build') {
			steps {        
        dir("${env.WORK_DIR}") {
          sh 'docker build -t ${env.IMAGE_NAME}:${env.IMAGE_TAG} .'
        }
			}
		}

    stage('Docker Push') {
      agent any
      steps {
        withCredentials([usernamePassword(credentialsId: '${env.DOCKERHUB_CREDENTIALS}', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
          sh "docker login -u ${env.dockerHubUser} -p ${env.dockerHubPassword}"
          sh 'docker push ${env.IMAGE_NAME}:${env.IMAGE_TAG}'
        }
      }
    }
	}

	post {
		always {
      echo "$IMAGE_NAME:$IMAGE_TAG"
		}
	}

}